<template>
    <div class="chart dashboard__section">
        <h2 class="dashboard__section__title">History</h2>
        <div class="chart__container">
            <line-chart
              :data="datacollection"
              :styles="myStyles"
              :gradient1="chartColor"
              :gradient2="gradient2"
            />
        </div>
    </div>
</template>

<script>
import themes from '@/assets/theme'
import Months from '@/utilities/months'
import { mapGetters } from 'vuex'
import LineChart from '@/components/Charts/Line'
export default {
  data () {
    return {
      datacollection: {
        labels: [],
        datasets: []
      },
      myStyles: {
        height: '170px',
        width: '100%',
        position: 'relative'
      }
    }
  },
  displayFromNowTo30DaysBefore () {
  },
  created () {
    const activeDate = new Date(this.$store.state.auth.activeDate)
    const endActiveDate = new Date(new Date().setDate(activeDate.getDate() + 31))
    if (new Date() <= endActiveDate) {
      this.displayFromActiveTo30DaysAfter(activeDate)
    }

    // console.log('demo', demo)

    // console.log('history', this.$store.state.auth.activeDate)
    // console.log('end', endActiveDate)
    // console.log(new Date() <= endActiveDate)

    const today = new Date()
    const data = []

    for (let i = 31; i >= 0; i--) {
      const fullDate = new Date(new Date().setDate(today.getDate() - i))
      let month = fullDate.getMonth() + 1
      if (month < 10) {
        month = `0${month}`
      }
      const labelData = {
        fullDate: fullDate,
        shortDate: `${month}/${fullDate.getDate()}`,
        transactions: [],
        balanceVariation: 0,
        balance: 0
      }
      data.push(labelData)
    }

    this.userTransactions.forEach(transaction => {
      if (transaction.details !== 'Initialization') {
        const fullDate = new Date(transaction.date)
        let month = fullDate.getMonth() + 1
        if (month < 10) {
          month = `0${month}`
        }
        const shortDate = `${month}/${fullDate.getDate()}`
        data.forEach(label => {
          if (label.shortDate === shortDate) {
            label.balanceVariation += transaction.amount
            label.transactions.push(transaction)
          }
        })
      }
    })

    data.reverse()
    let balance = this.userBalance
    data.forEach((label, index) => {
      label.balance = balance
      balance -= label.balanceVariation
    })
    data.reverse()

    const balanceData = []
    let currentMonth = null

    data.forEach(label => {
      balanceData.push(label.balance)
      if (!currentMonth) {
        currentMonth = Months[parseInt(label.shortDate.split('/')[0]) - 1]
        this.datacollection.labels.push(`${currentMonth} ${label.shortDate.split('/')[1]}`)
      } else {
        if (currentMonth === Months[parseInt(label.shortDate.split('/')[0]) - 1]) {
          this.datacollection.labels.push(`${label.shortDate.split('/')[1]}`)
        } else {
          currentMonth = Months[parseInt(label.shortDate.split('/')[0]) - 1]
          this.datacollection.labels.push(`${currentMonth} ${label.shortDate.split('/')[1]}`)
        }
      }
    })

    this.datacollection.datasets = [{
      borderColor: themes[this.theme.currentTheme]['--mainColor'],
      pointBackgroundColor: themes[this.theme.currentTheme]['--mainColor'],
      label: 'Balance',
      fill: false,
      data: balanceData
    }]
  },
  mounted () {
    // console.log('theme', this.theme.currentTheme)
  },
  computed: {
    ...mapGetters([
      'user',
      'userTransactions',
      'userBalance',
      'theme'
    ]),
    chartColor () {
      return themes[this.theme.currentTheme]['--secondaryColor']
      // return themes[this.theme.currentTheme]['--secondaryColor']
    },
    gradient2 () {
      if (this.theme.isDark) {
        return 'transparent'
      } else {
        return 'transparent'
      }
    }
  },
  methods: {
    displayFromActiveTo30DaysAfter (activeDate) {
      const data = []
      for (let i = -1; i < 31; i++) {
        const fullDate = new Date(new Date().setDate(activeDate.getDate() + i))
        let month = fullDate.getMonth() + 1
        if (month < 10) {
          month = `0${month}`
        }
        const labelData = {
          fullDate: fullDate,
          shortDate: `${month}/${fullDate.getDate()}`,
          transactions: [],
          balanceVariation: 0,
          balance: 0
        }
        data.push(labelData)
      }

      this.userTransactions.forEach(transaction => {
        if (transaction.details !== 'Initialization') {
          const fullDate = new Date(transaction.date)
          let month = fullDate.getMonth() + 1
          if (month < 10) {
            month = `0${month}`
          }
          const shortDate = `${month}/${fullDate.getDate()}`
          data.forEach(label => {
            if (label.shortDate === shortDate) {
              label.balanceVariation += transaction.amount
              label.transactions.push(transaction)
            }
          })
        }
      })
      console.log('data', data)
    }
  },
  components: {
    LineChart
  }
}
</script>

<style lang="scss" scoped>
.chart {
    width: 100%;
    height: 100%;
    &__container {
        position: relative;
        width: 100%;
        height: 17rem;
    }
}
</style>
